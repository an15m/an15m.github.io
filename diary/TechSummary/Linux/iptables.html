<p>在创建防火墙规则时，通常没必要创建相反方向的防火墙规则，防火墙将自动计算出这个规则。</p>
<h2 id="iptables中的表"><a href="#iptables中的表" class="headerlink" title="iptables中的表"></a>iptables中的表</h2><p>iptables根据功能划分不同的表来处理不同的功能逻辑，当前包含5个表，分别为filter、nat、mangle、raw和security。</p>
<h3 id="filter过滤表"><a href="#filter过滤表" class="headerlink" title="filter过滤表"></a>filter过滤表</h3><p>filter是iptables的默认表，主要用于报文过滤，在这里根据报文的内容对报文进行丢弃或者接受。它包含有3个内置规则链。</p>
<ul>
<li>INPUT输入链，处理目标地址为本机IP地址的报文。</li>
<li>OUTPUT输出链，处理本机IP地址产生的报文。</li>
<li>FORWARD转发链，处理经过本机路由的报文。<br>这样每个IP的报文只经过这3个内置链中的一个，便于进行数据报文匹配和处理。这里是真正实现防火墙处理的地方。注意：</li>
<li>经过本机转发的报文只经过FORWARD链。</li>
<li>本机产生的报文只经过OUTPUT链。</li>
<li>去往主机的报文只经过该主机的INPUT链。</li>
</ul>
<h3 id="nat网络地址转换表"><a href="#nat网络地址转换表" class="headerlink" title="nat网络地址转换表"></a>nat网络地址转换表</h3><p>nat用来完成源/目的地址和端口的转换，当一个报文在创建一个新的连接时进入该表。它也有3个内置规则链。</p>
<ul>
<li>PREROUTING：用于修改到来的报文，只用来做网络地址转换。</li>
<li>OUTPUT：用于修改本机产生的并且在路由处理之前的报文。</li>
<li>POSTROUTING：用于修改准备出去的报文的地方。<br>网络地址转换在路由功能前后都可能发生，源地址抓换是在数据包通过路由之后在POSTROUTING规则链进行地址转换。目的地址转换是在路由之前，在PREROUTING规则链进行地址转换。</li>
</ul>
<h3 id="mangle修改表"><a href="#mangle修改表" class="headerlink" title="mangle修改表"></a>mangle修改表</h3><p>这个表主要用来进行报文修改，有5个内置规则链。</p>
<ul>
<li>PREROUTING：针对到来的报文，在路由之前修改的地方。</li>
<li>INPUT：针对目的地址为网管本身的报文。</li>
<li>FORWARD：针对通过网管路由转发的报文。</li>
<li>POSTROUTING：将要发送出去的报文的地方。</li>
<li>OUTPUT：本机产生报文在路由之前修改的地方。<br>通常使用该表进行报文修改，以便进行Qos和策略路由。通常每一个报文都进入该表，但不使用它来做报文过滤。</li>
</ul>
<h3 id="raw原始表"><a href="#raw原始表" class="headerlink" title="raw原始表"></a>raw原始表</h3><p>这个表很少被用到，主要用于配置跟连接踪相关内容，在ip_conntrack之前调用。它提供了两个内置规则。</p>
<ul>
<li>PREROUTING：到达本机的报文。</li>
<li>OUTPUT：本机进程产生的报文。<br>此外还有security表，这个表用于安全linux的防火墙规则，是iptables最近新增表，在实际项目中还很少用到。</li>
</ul>
<h2 id="处理目标"><a href="#处理目标" class="headerlink" title="处理目标"></a>处理目标</h2><p>防火墙规则检测报文的特征是否符合规则，如果匹配，就进入规则的处理目标（TARGET）中。如果报文不匹配则进入该规则链的下一条规则进行检测。就这样逐条规则进行比较，知道整个规则链比较完成。规则的处理目标可以是用户定义的自定义链名，也可以是系统内置的4种处理方式。</p>
<ul>
<li>ACCEPT：接收，表示让这个报文通过。</li>
<li>DROP：丢弃，表示将这个报文丢弃。</li>
<li>QUEUE：入队，表示将这个报文传递到用户空间的队列中。</li>
<li>RETURN：返回，表示停止这条规则链的匹配，返回到调用这个规则链的上一条规则链的规则处执行。如果达到了一个内建的规则链的末端，或者遇到内置链的规则目标是TARGET，报文的命运将由规则链指定的默认目标处理方式决定。<br>还有其他拓展的目标处理方式，例如REJECT、DNAT、SNAT、MASQUERADE、LOG和REDIRECT等。</li>
</ul>
<hr>
<p>iptables -t nat -L -n -v</p>
<p>iptables -t nat -A PREROUTING -i p32p1 -d 192.168.2.50 -p tcp –dport 25901 -j DNAT –to-destination 192.168.1.37:5901</p>
<p>iptables -t nat -A PREROUTING -i p32p1 -d 192.168.2.50 -p tcp –dport 20022 -j DNAT –to-destination 192.168.1.37:22</p>
